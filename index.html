<meta charset="UTF-8">
<title>snort 'n' paste</title>
<style>
    body {
        font: 20px arial;
        /*background: linear-gradient(#c9fffa 0%, #c2b5ff 100%);
        background-attachment: fixed;*/
        background: #b5c8ff;
    }
    #wrapper {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
    }
    .input {
        display: inline-block;
        border: 1px solid #aaa;
        margin: 10px;
        /*box-shadow: inset 0 1px 2px #ccc;*/
        width: 30em;
        overflow: scroll;
        background: #fff;
        border-radius: 5px;
    }
    .text {
        outline: none;
        white-space: nowrap;
        padding: 10px;
    }
    #nose {
        position: absolute;
        top: 0px;
        left: 20px;
        cursor: grab;
    }
    #nose.grabbing {
        cursor: grabbing;
    }
    #nose .inner {
        position: relative;
        /*transform: rotate(-10deg);*/
        transition: rotate .2s ease-in-out;
    }
    #nose .inner .center {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 120;
        width: 100%;
        height: 100%;
        background: radial-gradient(#f003 0px, #f003 3px, #f000 3px);
    }
    #nose img {
        position: relative;
        top: 55px;
        z-index: 100;
        width: 150px;
    }
    .nostril.left {
        position: absolute;
        top: 200px;
        left: 30px;
        z-index: 110;
        width: 3px;
        height: 3px;
        /*background: #f0f;*/
    }
    .nostril.right {
        position: absolute;
        top: 200px;
        right: 30px;
        z-index: 110;
        width: 3px;
        height: 3px;
        /*background: #f0f;*/
    }
    .snort {
        position: absolute;
    }
    footer {
        position: absolute;
        bottom: 5px;
        font-weight: light;
    }
</style>

<div id="wrapper">
    <div id="nose">
        <div class="inner">
            <!--<div class="center"></div>-->
            <img src="nose.png" />
            <div class="nostril left"></div>
            <div class="nostril right"></div>
        </div>
    </div>

    <div class="input">
        <div class="text" contenteditable="true">if you have any questions the nose knows.</div>
        <!--<div class="text" contenteditable="true">123456789012345678901234567890123456789012345678901234567890</div>-->
        <!--<div id="text" contenteditable="true">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aenean molestie elementum arcu ultricies aliquam. Nullam scelerisque rutrum aliquet. Nullam pharetra felis et tincidunt pulvinar. Proin id augue convallis, imperdiet leo at, viverra metus. Nulla posuere est orci, at pulvinar justo placerat sagittis. In consectetur pellentesque ex. Duis eu rhoncus mauris. Aliquam erat volutpat. Etiam ullamcorper quam mi, a pellentesque massa tincidunt rutrum. In non purus vitae dolor porttitor efficitur. Aenean feugiat facilisis ipsum et volutpat. Duis tempus venenatis elit ac fermentum. Aliquam commodo dictum nulla sit amet bibendum. Nulla ullamcorper massa at tincidunt auctor. Aenean quis turpis in velit aliquam varius nec eget tellus.</div>-->
    </div>
    <div id="snorts"></div>

    <footer>snort 'n' paste &nbsp; &mdash; &nbsp; grab the nose. &nbsp; c to snort. &nbsp; v to de-snort. &nbsp; r to rocket. &nbsp; &mdash; &nbsp; by <a href="https://matthew.rayfield.world">matthew rayfield</a> in 2024</footer>
</div>

<script>
    const noseElement = document.getElementById('nose');
    const textElement = document.querySelector('.text');
    const textRect = textElement.getBoundingClientRect();
    const snortsElement = document.getElementById('snorts');
    const nostrilLeft = document.querySelector('.nostril.left');
    const nostrilRight = document.querySelector('.nostril.right');
    const noseInner = document.querySelector('#nose .inner');
    let grabbing = false;
    let offsetX = 0;
    let offsetY = 0;
    let cDown = false;
    let vDown = false;
    let spans = [];
    let rects = [];
    let snorts = [];
    let buffer = [];
    let lastPaste = 0;
    let inAir = false;
    let lastX;
    let lastMove;
    let nostrilActive = nostrilLeft;
    let noseAngle = 0;

    function normalize(coord) {
        const magnitude = Math.sqrt(
            (coord.x * coord.x) + (coord.y * coord.y)
        );

        return {
            x: coord.x / magnitude,
            y: coord.y / magnitude
        };
    }

    function calcDistance(coordA, coordB) {
        const a = coordA.x - coordB.x;
        const b = coordA.y - coordB.y;

        return Math.hypot(a, b);
    }

    function spanerize() {
        const split = textElement.innerText.split('');
        spans = [];

        textElement.innerHTML = '';
        split.forEach(letter => {
            if (letter == ' ') letter = '&nbsp;';
            const span = document.createElement('span');

            span.innerHTML = letter;
            textElement.appendChild(span);

            spans.push(span);
        });
    }

    function despanerize() {
        let text = textElement.innerText.replace(/\n/g, '');
        textElement.innerHTML = text;
    }

    function loop() {
        const nostrilRect = nostrilActive.getBoundingClientRect();
        const newSnorts = [];

        if (inAir && !snorts.length) {
            despanerize();
            inAir = false;
        }

        // movement:
        snorts.forEach(snort => {
            const snortSpan = snort.span;

            if (snort.direction == 0) { // upward
                const direction = normalize({
                    x: nostrilRect.x - snort.x,
                    y: nostrilRect.y - snort.y
                });

                const speed = 7;
                const x = snort.x + (direction.x*speed);
                const y = snort.y + (direction.y*speed);

                snortSpan.style.left = snort.x = x;
                snortSpan.style.top = snort.y = y;

                const distance = calcDistance({x, y}, nostrilRect);
                if (distance < 15) {
                    buffer.push(snortSpan.innerText);
                    snortsElement.removeChild(snortSpan);
                }
                else {
                    newSnorts.push(snort);
                }
            }
            else if (snort.direction == 1) { // downward
                snort.x += snort.xv;
                snort.y += snort.yv;

                snortSpan.style.left = snort.x;
                snortSpan.style.top = snort.y;

                if (snort.x >= textRect.left && snort.x <= textRect.right && snort.y >= textRect.top && snort.y <= textRect.bottom) {
                    const newSpan = document.createElement('span');
                    newSpan.innerHTML = snortSpan.innerText;

                    if (!spans.length) {
                        textElement.appendChild(newSpan);
                        spans.unshift(newSpan);
                    }
                    else {
                        spans.forEach((span, i) => {
                            const rect = span.getBoundingClientRect();
                            const xa = rect.x;
                            const xb = xa + rect.width;

                            if (i == 0 && snort.x < xa) {
                                span.before(newSpan);
                                spans.unshift(newSpan);
                            }
                            else if (snort.x >= xa && (snort.x < xb || i == spans.length - 1)) {
                                span.after(newSpan);
                                spans.push(newSpan);
                            }
                        });
                    }

                    snortsElement.removeChild(snortSpan);
                }
                else if (snort.y < window.innerHeight + 50) {
                    newSnorts.push(snort);
                }
            }
        });

        snorts = newSnorts;

        // copy:
        if (cDown) {
            const newSpans = [];

            spans.forEach((span, i) => {
                const spanRect = span.getBoundingClientRect();
                const distance = calcDistance(nostrilRect, spanRect);

                if (distance < 50) {
                    const snortSpan = document.createElement('span');
                    snortSpan.className = 'snort';
                    const snortRect = span.getBoundingClientRect();
                    snortSpan.style.left = snortRect.x;
                    snortSpan.style.top = snortRect.y;
                    snortSpan.innerHTML = span.innerHTML;
                    snortsElement.appendChild(snortSpan);

                    snorts.push({
                        span: snortSpan,
                        direction: 0,
                        x: snortRect.x,
                        y: snortRect.y
                    });

                    textElement.removeChild(span);
                }
                else {
                    newSpans.push(span);
                }
            });

            spans = newSpans;
        }

        // paste:
        if (vDown) {
            const now = performance.now();
            const diff = now - lastPaste;

            if (diff > 50) {
                const l = buffer.pop();
                if (l) {
                    const speed = 3;
                    inAir = true;
                    const snortSpan = document.createElement('span');
                    snortSpan.className = 'snort';
                    const x = nostrilRect.x;
                    const y = nostrilRect.y;
                    snortSpan.style.left = x;
                    snortSpan.style.top = y;
                    snortSpan.innerHTML = l;
                    snortsElement.appendChild(snortSpan);

                    snorts.push({
                        span: snortSpan,
                        direction: 1,
                        x: x,
                        y: y,
                        xv: 1*speed * noseAngle,
                        yv: 2*speed
                    });

                    lastPaste = now;
                }
            }
        }

        setTimeout(loop, 1000/60);
    }
    loop();

    window.addEventListener('load', () => {
        document.body.addEventListener('mousemove', event => {
            if (grabbing) {
                event.preventDefault();

                let x = event.pageX + offsetX;
                let y = event.pageY + offsetY;

                const now = performance.now();
                if (lastMove != undefined) {
                    const diff = now - lastMove;
                    const speed = (x - lastX) / diff;

                    if (speed > .3) {
                        noseInner.style.rotate = '15deg';
                        noseAngle = -1;
                        nostrilActive = nostrilRight;
                    }
                    else if (speed < -.3) {
                        noseInner.style.rotate = '-15deg';
                        noseAngle = 1;
                        nostrilActive = nostrilLeft;
                    }
                }

                noseElement.style.left = x;
                noseElement.style.top = y;

                lastMove = now;
                lastX = x;
            }
        });

        noseElement.addEventListener('mousedown', event => {
            event.preventDefault();
            textElement.blur();

            lastX = undefined;
            lastMove = undefined;
            grabbing = true;
            noseElement.className = 'grabbing';

            const rect = nose.getBoundingClientRect();
            offsetX = rect.x - event.pageX;
            offsetY = rect.y - event.pageY;
        });

        document.body.addEventListener('mouseup', event => {
            grabbing = false;
            noseElement.className = '';
            noseInner.style.rotate = '0deg';
            noseAngle = 0;
        });

        document.body.addEventListener('keydown', event => {
            if (event.ctrlKey || event.metaKey) return;

            if (event.which == 67) { // c
                if (!cDown) {
                    spanerize();
                    rects = [];
                    spans.forEach(span => {
                        rects.push(span.getBoundingClientRect());
                    });
                    spans.forEach((span, i) => {
                        const spanRect = rects[i];
                        span.style.position = 'absolute';
                        span.style.left = spanRect.x;
                        span.style.top = spanRect.y;
                    });
                    cDown = true;
                }
            }
            else if (event.which == 86) { // v
                if (!vDown) {
                    spanerize();
                    vDown = true;
                }
            }
            else if (event.which == 82) { // r
                if (buffer.length) {
                    spanerize();
                    inAir = true;
                    buffer.forEach(l => {
                        const nostrilRect = (Math.random()>.5 ? nostrilLeft : nostrilRight).getBoundingClientRect();
                        const snortSpan = document.createElement('span');
                        snortSpan.className = 'snort';
                        const spread = 15;
                        const x = nostrilRect.x + ((Math.random()-.5)*spread);
                        const y = nostrilRect.y + ((Math.random()-.5)*spread);
                        snortSpan.style.left = x;
                        snortSpan.style.top = y;
                        snortSpan.innerHTML = l;
                        snortsElement.appendChild(snortSpan);
                        const speed = 1.2;

                        snorts.push({
                            span: snortSpan,
                            direction: 1,
                            x: x,
                            y: y,
                            xv: ((Math.random()-.5)*5)*speed,
                            yv: (7+((Math.random()-.5)*2))*speed
                        });
                    });
                    buffer = [];
                }
            }
            else console.log(event.which);
        });

        document.body.addEventListener('keyup', event => {
            if (event.which == 67) { // c
                if (cDown) despanerize();
                cDown = false;
            }
            else if (event.which == 86) { // v
                if (vDown && !inAir) despanerize();
                vDown = false;
                lastPaste = 0;
            }
        });
    });
</script>
