<style>
    body {
        font: 20px arial;
    }
    #wrapper {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        display: flex;
        justify-content: left;
        align-items: center;
        overflow: scroll;
    }
    #text {
        padding: 10px;
        outline: none;
        white-space: nowrap;
    }
    #nose {
        position: absolute;
        top: 100px;
        left: 100px;
        transform: rotate(-10deg);
    }
    #nose img {
        position: relative;
        z-index: 100;
        width: 150px;
    }
    .nostril.left {
        position: absolute;
        bottom: 30px;
        left: 30px;
        z-index: 110;
        width: 3px;
        height: 3px;
        background: #f0f;
    }
    .snort {
        position: absolute;
    }
</style>

<div id="wrapper">
    <div id="nose">
        <img src="nose.png" />
        <div class="nostril left"></div>
    </div>

    <div id="text" contenteditable="true">1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890</div>
    <!--<div id="text" contenteditable="true">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aenean molestie elementum arcu ultricies aliquam. Nullam scelerisque rutrum aliquet. Nullam pharetra felis et tincidunt pulvinar. Proin id augue convallis, imperdiet leo at, viverra metus. Nulla posuere est orci, at pulvinar justo placerat sagittis. In consectetur pellentesque ex. Duis eu rhoncus mauris. Aliquam erat volutpat. Etiam ullamcorper quam mi, a pellentesque massa tincidunt rutrum. In non purus vitae dolor porttitor efficitur. Aenean feugiat facilisis ipsum et volutpat. Duis tempus venenatis elit ac fermentum. Aliquam commodo dictum nulla sit amet bibendum. Nulla ullamcorper massa at tincidunt auctor. Aenean quis turpis in velit aliquam varius nec eget tellus.</div>-->
    <div id="snorts"></div>
</div>

<script>
    const noseElement = document.getElementById('nose');
    const textElement = document.getElementById('text');
    const textRect = textElement.getBoundingClientRect();
    const snortsElement = document.getElementById('snorts');
    const nostrilLeft = document.querySelector('.nostril.left');
    let dragging = false;
    let offsetX = 0;
    let offsetY = 0;
    let cDown = false;
    let vDown = false;
    let spans = [];
    let rects = [];
    let snorts = [];
    let buffer = [];
    let lastPaste = 0;
    let inAir = false;

    function normalize(coord) {
        const magnitude = Math.sqrt(
            (coord.x * coord.x) + (coord.y * coord.y)
        );

        return {
            x: coord.x / magnitude,
            y: coord.y / magnitude
        };
    }

    function calcDistance(coordA, coordB) {
        const a = coordA.x - coordB.x;
        const b = coordA.y - coordB.y;

        return Math.hypot(a, b);
    }

    function spanerize() {
        const split = textElement.innerText.split('');
        spans = [];

        textElement.innerHTML = '';
        split.forEach(letter => {
            if (letter == ' ') letter = '&nbsp;';
            const span = document.createElement('span');

            span.innerHTML = letter;
            textElement.appendChild(span);

            spans.push(span);
        });
    }

    function despanerize() {
        let text = textElement.innerText.replace(/\n/g, '');
        console.log(text);
        textElement.innerHTML = text;
    }

    function loop() {
        const nostrilRect = nostrilLeft.getBoundingClientRect();
        const newSnorts = [];

        if (inAir && !snorts.length) {
            despanerize();
            inAir = false;
        }

        snorts.forEach(snort => {
            const snortSpan = snort.span;

            if (snort.direction == 0) {
                const direction = normalize({
                    x: nostrilRect.x - snort.x,
                    y: nostrilRect.y - snort.y
                });

                const speed = 7;
                const x = snort.x + (direction.x*speed);
                const y = snort.y + (direction.y*speed);

                snortSpan.style.left = snort.x = x;
                snortSpan.style.top = snort.y = y;

                const distance = calcDistance({x, y}, nostrilRect);
                if (distance < 15) {
                    buffer.push(snortSpan.innerText);
                    snortsElement.removeChild(snortSpan);
                }
                else {
                    newSnorts.push(snort);
                }
            }
            else if (snort.direction == 1) {
                snort.x += snort.xv;
                snort.y += snort.yv;

                snortSpan.style.left = snort.x;
                snortSpan.style.top = snort.y;

                if (snort.y < textRect.y) {
                    newSnorts.push(snort);
                }
                else {
                    spans.forEach((span, i) => {
                        const rect = span.getBoundingClientRect();
                        const xa = rect.x;
                        const xb = xa + rect.width;

                        if (snort.x >= xa && snort.x < xb) {
                            const span = spans[i];
                            const newSpan = document.createElement('span');
                            newSpan.innerHTML = snortSpan.innerText;
                            textElement.insertBefore(newSpan, span);
                            spans.push(newSpan);
                        }
                    });
                    snortsElement.removeChild(snortSpan);
                }
            }
        });

        snorts = newSnorts;

        if (cDown) {
            const newSpans = [];

            spans.forEach((span, i) => {
                const spanRect = span.getBoundingClientRect();
                const distance = calcDistance(nostrilRect, spanRect);

                if (distance < 50) {
                    const snortSpan = document.createElement('span');
                    snortSpan.className = 'snort';
                    const snortRect = span.getBoundingClientRect();
                    snortSpan.style.left = snortRect.x;
                    snortSpan.style.top = snortRect.y;
                    snortSpan.innerHTML = span.innerHTML;
                    snortsElement.appendChild(snortSpan);

                    snorts.push({
                        span: snortSpan,
                        direction: 0,
                        x: snortRect.x,
                        y: snortRect.y
                    });

                    textElement.removeChild(span);
                }
                else {
                    newSpans.push(span);
                }
            });

            spans = newSpans;
        }

        if (vDown) {
            const now = performance.now();
            const diff = now - lastPaste;

            if (diff > 20) {
                const l = buffer.pop();
                if (l) {
                    inAir = true;
                    const snortSpan = document.createElement('span');
                    snortSpan.className = 'snort';
                    const x = nostrilRect.x;
                    const y = nostrilRect.y;
                    snortSpan.style.left = x;
                    snortSpan.style.top = y;
                    snortSpan.innerHTML = l;
                    snortsElement.appendChild(snortSpan);

                    snorts.push({
                        span: snortSpan,
                        direction: 1,
                        x: x,
                        y: y,
                        xv: 1*2,
                        yv: 2*2
                    });

                    lastPaste = now;
                }
            }
        }

        setTimeout(loop, 1000/60);
    }
    loop();

    window.addEventListener('load', () => {
        document.body.addEventListener('mouseup', () => {
            dragging = false;
        }); 

        document.body.addEventListener('mousemove', event => {
            event.preventDefault();

            if (dragging) {
                let x = event.pageX + offsetX;
                let y = event.pageY + offsetY;

                noseElement.style.left = x;
                noseElement.style.top = y;
            }
        });

        noseElement.addEventListener('mousedown', event => {
            event.preventDefault();

            const rect = nose.getBoundingClientRect();

            offsetX = rect.x - event.pageX;
            offsetY = rect.y - event.pageY;

            dragging = true;
        });

        document.body.addEventListener('keydown', event => {
            if (event.which == 67) {
                if (!cDown) {
                    spanerize();
                    rects = [];
                    spans.forEach(span => {
                        rects.push(span.getBoundingClientRect());
                    });
                    spans.forEach((span, i) => {
                        const spanRect = rects[i];
                        span.style.position = 'absolute';
                        span.style.left = spanRect.x;
                        span.style.top = spanRect.y;
                    });
                    cDown = true;
                }
            }
            else if (event.which == 86) {
                if (!vDown) {
                    spanerize();
                    vDown = true;
                }
            }
            else if (event.which == 82) {
                const nostrilRect = nostrilLeft.getBoundingClientRect();
                buffer.forEach(l => {
                    const snortSpan = document.createElement('span');
                    snortSpan.className = 'snort';
                    const spread = 15;
                    const x = nostrilRect.x + ((Math.random()-.5)*spread);
                    const y = nostrilRect.y + ((Math.random()-.5)*spread);
                    snortSpan.style.left = x;
                    snortSpan.style.top = y;
                    snortSpan.innerHTML = l;
                    snortsElement.appendChild(snortSpan);

                    snorts.push({
                        span: snortSpan,
                        direction: 1,
                        x: x,
                        y: y,
                        xv: (Math.random()-.5)*3+1,
                        yv: 7+((Math.random()-.5)*2)
                    });
                });
                buffer = [];
            }
            else console.log(event.which);
        });

        document.body.addEventListener('keyup', event => {
            if (event.which == 67) {
                if (cDown) despanerize();
                cDown = false;
                console.log(buffer.join(''));
            }
            else if (event.which == 86) {
                if (vDown && !inAir) despanerize();
                vDown = false;
                lastPaste = 0;
            }
        });
    });
</script>
